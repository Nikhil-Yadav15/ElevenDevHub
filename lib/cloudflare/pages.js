// src/lib/cloudflare/pages.js
import { cfRequest } from "./client";

/**
 * Generate a safe Pages project name
 */
export function generatePagesProjectName(repoName) {
  const clean = repoName
    .toLowerCase()
    .replace(/[^a-z0-9-]/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-|-$/g, "")
    .slice(0, 40);
  
  const random = Math.random().toString(36).slice(2, 8);
  return `eleven-${clean}-${random}`.slice(0, 58);
}

/**
 * Create a Direct Upload Pages project
 * Using minimal required fields for Direct Upload
 */
export async function createPagesProject(accountId, apiToken, projectName, productionBranch = "main") {
  const body = {
    name: projectName,
    production_branch: productionBranch,
  };
  
  console.log("Creating Pages project with body:", JSON.stringify(body, null, 2));
  
  const result = await cfRequest(
    accountId,
    apiToken,
    "/pages/projects",
    {
      method: "POST",
      body: JSON.stringify(body),
    }
  );
  
  return {
    name: result.name,
    subdomain: result.subdomain,
    productionBranch: result.production_branch,
    createdOn: result.created_on,
  };
}

/**
 * Get existing Pages project
 */
export async function getPagesProject(accountId, apiToken, projectName) {
  try {
    const result = await cfRequest(
      accountId,
      apiToken,
      `/pages/projects/${projectName}`
    );
    
    return {
      name: result.name,
      subdomain: result.subdomain,
      productionBranch: result.production_branch,
    };
  } catch (error) {
    if (error.message.includes("404")) {
      return null;
    }
    throw error;
  }
}

/**
 * List all Pages projects
 */
export async function listPagesProjects(accountId, apiToken) {
  const result = await cfRequest(
    accountId,
    apiToken,
    "/pages/projects"
  );
  
  return result.map(p => ({
    name: p.name,
    subdomain: p.subdomain,
    productionBranch: p.production_branch,
    createdOn: p.created_on,
  }));
}

/**
 * Delete Pages project
 */
export async function deletePagesProject(accountId, apiToken, projectName) {
  await cfRequest(
    accountId,
    apiToken,
    `/pages/projects/${projectName}`,
    { method: "DELETE" }
  );
  
  return { success: true };
}
